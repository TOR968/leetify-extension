import { callable, definePlugin, TextField } from '@steambrew/client';
import { useEffect, useState } from 'react';
import type { ChangeEvent } from 'react';
import { readSettingsApiKey, writeSettingsApiKey } from './settings';

const SettingsPanel = () => {
	const envApiKey = (import.meta as ImportMeta).env?.LEETIFY_API_KEY ?? '';
	const storedApiKey = readSettingsApiKey() || localStorage.getItem('leetifyApiKey') || envApiKey;

	const [apiKey, setApiKey] = useState(storedApiKey);
	const [status, setStatus] = useState('');

	useEffect(() => {
		const readApiKey = callable<[], string>('read_api_key');
		readApiKey()
			.then((backendKey) => {
				if (backendKey && backendKey !== apiKey) {
					setApiKey(backendKey);
				}
			})
			.catch((err) => console.error('Leetify [SettingsPanel]: Failed to read from backend:', err));
	}, []);

	useEffect(() => {
		const currentSettings = readSettingsApiKey();
		if (!currentSettings && storedApiKey) {
			writeSettingsApiKey(storedApiKey);
		}
	}, [storedApiKey]);

	const handleApiKeyChange = (event: ChangeEvent<HTMLInputElement>) => {
		setApiKey(event.target.value);
		setStatus('');
	};

	const handleSave = async () => {
		if (apiKey) {
			localStorage.setItem('leetifyApiKey', apiKey);
		} else {
			localStorage.removeItem('leetifyApiKey');
		}

		await writeSettingsApiKey(apiKey);

		setStatus('Saved!');
		setTimeout(() => setStatus(''), 2000);
	};

	return (
		<div style={{ display: 'flex', flexDirection: 'column', gap: '12px', padding: '8px 0' }}>
			<TextField
				label="Leetify API Key"
				value={apiKey}
				onChange={handleApiKeyChange}
				description="Paste your API key or set LEETIFY_API_KEY in .env"
				bIsPassword={true}
			/>
			<div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
				<button
					onClick={handleSave}
					style={{
						padding: '8px 16px',
						backgroundColor: '#1a9fff',
						color: 'white',
						border: 'none',
						borderRadius: '2px',
						cursor: 'pointer',
						fontSize: '14px',
						fontWeight: 500,
					}}
					onMouseOver={(e) => (e.currentTarget.style.backgroundColor = '#1589da')}
					onMouseOut={(e) => (e.currentTarget.style.backgroundColor = '#1a9fff')}
				>
					Save
				</button>
				{status && <span style={{ color: '#66c0f4', fontSize: '13px' }}>{status}</span>}
			</div>
		</div>
	);
};

const LeetifyIcon = () => (
	<svg style={{ height: '1em' }} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 629 127">
		<path
			fill="#fff"
			d="M225.196 76.6329h-4.183c-1.95 0-3.531-1.5838-3.531-3.5375 0-.257.028-.5134.083-.7644l1.723-7.7978c.43-1.9439 2.15-3.3276 4.138-3.3276h5.165c3.133-9.6014 8.219-17.296 15.26-23.0841 8.056-6.6229 17.658-9.9344 28.805-9.9344 10.033 0 17.608 2.5728 22.725 7.7183 5.118 5.1455 7.676 12.2014 7.676 21.1679 0 3.3624-.405 7.1833-1.216 11.4628l-.992 4.4322c-.203 1.019-.735 1.885-1.597 2.5983-.861.7132-1.849 1.0698-2.964 1.0698h-50.385c-.304 1.8341-.456 3.5662-.456 5.1965 0 4.2794 1.089 7.7692 3.268 10.4693 2.179 2.7001 5.346 4.0502 9.5 4.0502 5.777 0 10.996-2.3435 15.657-7.0305 1.115-1.1208 1.976-1.8086 2.584-2.0633.608-.2547 1.52-.3821 2.736-.3821h13.377c.912 0 1.621.3057 2.128.917.507.6114.659 1.3755.456 2.2926-.709 2.4454-2.863 5.2983-6.46 8.5588-3.598 3.2601-8.31 6.0881-14.137 8.4821-5.827 2.395-12.236 3.592-19.229 3.592-9.728 0-17.227-2.445-22.497-7.336-5.269-4.8909-7.904-11.8704-7.904-20.9388 0-2.0637.09-4.0008.27-5.8113zm23.943-15.4273h8.929v.0298c9.855-.0026 24.338-.0227 24.342-.0451.287-1.6419.431-3.3199.431-5.034 0-4.2795-1.115-7.6673-3.345-10.1637-2.229-2.4963-5.472-3.7445-9.728-3.7445-5.168 0-9.627 1.8086-13.377 5.4257-3.558 3.4325-5.975 7.9431-7.252 13.5318zm-65.234 47.9854c-1.114 0-1.95-.357-2.508-1.07-.557-.713-.734-1.58-.532-2.598L202.45 4.3446c.203-1.1208.71-2.0123 1.52-2.6746.811-.6623 1.723-.9935 2.736-.9935h12.921c1.013 0 1.799.3566 2.356 1.0699.557.7132.735 1.5793.532 2.5982L201.082 105.523c-.203 1.018-.709 1.885-1.52 2.598-.811.713-1.723 1.07-2.736 1.07h-12.921zm155.443 1.528c-9.728 0-17.227-2.445-22.497-7.336-5.269-4.8909-7.904-11.8704-7.904-20.9388 0-3.4643.253-6.5719.76-9.323.101-.7133.659-3.2605 1.672-7.6419 2.939-11.6156 8.436-20.7348 16.493-27.3578 8.056-6.6229 17.658-9.9344 28.805-9.9344 10.032 0 17.607 2.5728 22.725 7.7183 5.118 5.1455 7.676 12.2014 7.676 21.1679 0 3.3624-.405 7.1833-1.216 11.4628l-1.026 4.4322c-.202 1.019-.734 1.885-1.596 2.5983-.861.7132-1.849 1.0698-2.964 1.0698h-50.352c-.304 1.8341-.456 3.5662-.456 5.1965 0 4.2794 1.089 7.7692 3.268 10.4693 2.179 2.7001 5.346 4.0502 9.5 4.0502 5.777 0 10.996-2.3435 15.657-7.0305 1.115-1.1208 1.976-1.8086 2.584-2.0633.608-.2547 1.52-.3821 2.736-.3821h13.377c.912 0 1.621.3057 2.128.917.507.6114.659 1.3755.456 2.2926-.709 2.4454-2.863 5.2983-6.46 8.5588-3.598 3.2601-8.31 6.0881-14.137 8.4821-5.827 2.395-12.236 3.592-19.229 3.592-9.728 0-17.227-2.445-22.497-7.336-5.269-4.8909-7.904-11.8704-7.904-20.9388 0-2.0637.09-4.0008.27-5.8113zm23.943-15.4273h8.929v.0298c9.855-.0026 24.338-.0227 24.342-.0451.287-1.6419.431-3.3199.431-5.034 0-4.2795-1.115-7.6673-3.345-10.1637-2.229-2.4963-5.472-3.7445-9.728-3.7445-5.168 0-9.627 1.8086-13.377 5.4257-3.558 3.4325-5.975 7.9431-7.252 13.5318zm-65.234 47.9854c-1.114 0-1.95-.357-2.508-1.07-.557-.713-.734-1.58-.532-2.598L202.45 4.3446c.203-1.1208.71-2.0123 1.52-2.6746.811-.6623 1.723-.9935 2.736-.9935h12.921c1.013 0 1.799.3566 2.356 1.0699.557.7132.735 1.5793.532 2.5982L201.082 105.523c-.203 1.018-.709 1.885-1.52 2.598-.811.713-1.723 1.07-2.736 1.07h-12.921zm155.443 1.528c-9.728 0-17.227-2.445-22.497-7.336-5.269-4.8909-7.904-11.8704-7.904-20.9388 0-3.4643.253-6.5719.76-9.323.101-.7133.659-3.2605 1.672-7.6419 2.939-11.6156 8.436-20.7348 16.493-27.3578 8.056-6.6229 17.658-9.9344 28.805-9.9344 10.032 0 17.607 2.5728 22.725 7.7183 5.118 5.1455 7.676 12.2014 7.676 21.1679 0 3.3624-.405 7.1833-1.216 11.4628l-1.026 4.4322c-.202 1.019-.734 1.885-1.596 2.5983-.861.7132-1.849 1.0698-2.964 1.0698h-50.352c-.304 1.8341-.456 3.5662-.456 5.1965 0 4.2794 1.089 7.7692 3.268 10.4693 2.179 2.7001 5.346 4.0502 9.5 4.0502 5.777 0 10.996-2.3435 15.657-7.0305 1.115-1.1208 1.976-1.8086 2.584-2.0633.608-.2547 1.52-.3821 2.736-.3821h13.377c.912 0 1.621.3057 2.128.917.507.6114.659 1.3755.456 2.2926-.709 2.4454-2.863 5.2983-6.46 8.5588-3.598 3.2601-8.31 6.0881-14.137 8.4821-5.827 2.395-12.236 3.592-19.229 3.592-9.728 0-17.227-2.445-22.497-7.336-5.269-4.8909-7.904-11.8704-7.904-20.9388 0-2.0637.09-4.0008.27-5.8113z"
		/>
		<path
			fill="#bf3b68"
			d="M60.8196 34.3824L68.1151 0H150.03c4.389 0 7.946 3.5635 7.946 7.9592 0 .5585-.059 1.1155-.175 1.6617L137.78 103.565c-1.044 4.897-5.363 8.397-10.361 8.397H94.7336L109.73 42.0881c.738-3.4381-1.446-6.8243-4.878-7.5635a6.3497 6.3497 0 00-1.336-.1422H60.8196z"
			clipRule="evenodd"
		/>
		<path
			fill="#f84982"
			d="M51.799 40.2235a8.107 8.107 0 00-.107.436l-5.9366 27.5032c-.6182 2.8643 1.1986 5.6883 4.0581 6.3076a5.286 5.286 0 001.1194.1199h18.7043c2.9255 0 5.2971 2.3756 5.2971 5.3061 0 .3735-.0394.746-.1174 1.1112l-6.6182 30.9545H7.9457C3.5574 111.962 0 108.398 0 104.003a7.97 7.97 0 01.1751-1.662L20.1967 8.3966C21.2403 3.5 25.5589 0 30.5575 0h29.7291L51.799 40.2235z"
			clipRule="evenodd"
		/>
	</svg>
);

export default definePlugin(() => {
	return {
		name: 'leetify-extension',
		title: 'Leetify Extension',
		icon: <LeetifyIcon />,
		content: <SettingsPanel />,
	};
});
